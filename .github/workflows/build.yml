name: build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
env:
    DOTNETVERSION:  6.0.100-rc.2.21505.57
    
jobs:
  build:

    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2
    
    # open PR should remove need for the script SOON! https://github.com/microsoft/setup-msbuild/pull/56
    # - name: Install Visual Studio Preview
    #   shell: pwsh
    #   run: powershell .\build\install-vs.ps1

    - name:  install .NET 6 preview
      shell: pwsh
      run: |
        $ProgressPreference = 'SilentlyContinue'
        Invoke-WebRequest -Uri "https://dot.net/v1/dotnet-install.ps1" -OutFile dotnet-install.ps1
        & .\dotnet-install.ps1 -Version ${{env.DOTNETVERSION}} -InstallDir "$env:ProgramFiles\dotnet\" -Verbose
        & dotnet --list-sdks
   
    # - name: Install workload
    #  shell: pwsh
    #  run: |
    #    & dotnet workload install android-aot
    #    & dotnet workload install ios
    #    & dotnet workload install maccatalyst
    #    & dotnet workload install maui
    #    & dotnet workload install wasm-tools
        
    - name: Install and Run maui-check Tool
      shell: pwsh
      run: |
        & dotnet tool update --global redth.net.maui.check
        & maui-check --manifest D:\a\Maui.Toolkit\Maui.Toolkit\maui.check.manifest.json --ci --non-interactive --fix --force-dotnet --skip vswin --skip edgewebview2

    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build
      run: dotnet build --no-restore
      
    - name: Start Android Emulator
      shell: pwsh
      run: |
        & cd 'C:\Program Files (x86)\Android\android-sdk\emulator\'
        & .\emulator.EXE -no-boot-anim -accel on -avd Android_Emulator_31 -prop monodroid.avdname=Android_Emulator_31
      
    # - name: Test
    #   run: .\unit-test.ps1
    #   working-directory: .\build
    #   shell: powershell
